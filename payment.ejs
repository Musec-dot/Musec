<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment - <%= job.title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }
        .payment-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .card-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        .card-number-input {
            letter-spacing: 2px;
            font-size: 18px;
        }
        .card-logo {
            filter: brightness(0) invert(1);
            opacity: 0.6;
        }
        .processing-overlay {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
        }
        .spinner {
            border: 3px solid rgba(255, 107, 53, 0.2);
            border-top-color: #ff6b35;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .success-checkmark {
            animation: scaleIn 0.5s ease-out;
        }
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }
        .security-badge {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
    </style>
</head>
<body>
    <!-- Floating Navbar -->
    <div class="navbar-container" style="position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; padding: 1.5rem 1rem 1rem 1rem; background-color: rgba(5, 5, 5, 0.95); backdrop-filter: blur(8px);">
        <nav style="background-color: #121212; border-radius: 9999px; padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 64rem; border: 1px solid rgba(255, 255, 255, 0.05);">
            <a href="/hirer/jobs" style="display: flex; align-items: center; color: #fff; text-decoration: none;">
                <i data-lucide="arrow-left" width="20" height="20" style="margin-right: 0.5rem;"></i>
                <span>Back to Jobs</span>
            </a>
        </nav>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2" style="background: linear-gradient(135deg, #fff 0%, #ff6b35 60%, #ff8c42 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Secure Payment Gateway
            </h1>
            <p class="text-gray-400">Complete your payment securely</p>
        </div>

        <% if (job.paymentStatus === 'paid') { %>
            <!-- Payment Completed View -->
            <div class="payment-card rounded-2xl p-8 mb-6">
                <div class="text-center">
                    <div class="success-checkmark inline-flex items-center justify-center w-20 h-20 bg-green-500/20 rounded-full mb-6">
                        <i data-lucide="check-circle" width="48" height="48" class="text-green-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-green-400 mb-4">Payment Successful!</h2>
                    <p class="text-gray-300 mb-6">Your payment has been processed successfully</p>
                    
                    <div class="bg-[#0a0a0a] rounded-lg p-6 mb-6 text-left max-w-md mx-auto">
                        <h3 class="text-lg font-semibold mb-4 text-center">Payment Receipt</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Job Title:</span>
                                <span class="text-white font-medium"><%= job.title %></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Musician:</span>
                                <span class="text-white font-medium"><%= job.selectedMusician.username %></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Amount Paid:</span>
                                <span class="text-[#ff6b35] font-bold text-lg"><%= job.payment %></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Payment Date:</span>
                                <span class="text-white"><%= new Date(job.paymentDate).toLocaleString() %></span>
                            </div>
                            <% if (payment && payment.transactionId) { %>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Transaction ID:</span>
                                <span class="text-white font-mono text-xs"><%= payment.transactionId %></span>
                            </div>
                            <% } %>
                            <% if (payment && payment.paymentMethod) { %>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Payment Method:</span>
                                <span class="text-white capitalize"><%= payment.paymentMethod.replace('_', ' ') %></span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    
                    <a href="/job/<%= job._id %>/track" class="inline-block bg-[#ff6b35] hover:bg-[#ff8c42] text-white font-semibold px-8 py-3 rounded-lg transition-colors">
                        Track Job Progress
                    </a>
                </div>
            </div>
        <% } else { %>
            <!-- Payment Form -->
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Left Column: Payment Form -->
                <div class="md:col-span-2">
                    <div class="payment-card rounded-2xl p-6">
                        <!-- Job Summary -->
                        <div class="bg-[#0a0a0a] rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold mb-3">Order Summary</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Job:</span>
                                    <span class="text-white"><%= job.title %></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Musician:</span>
                                    <span class="text-white"><%= job.selectedMusician.username %></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Location:</span>
                                    <span class="text-white"><%= job.location %></span>
                                </div>
                                <div class="border-t border-gray-700 pt-2 mt-2 flex justify-between">
                                    <span class="text-lg font-semibold">Total Amount:</span>
                                    <span class="text-[#ff6b35] font-bold text-xl"><%= job.payment %></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Tabs -->
                        <div class="mb-6">
                            <div class="flex gap-2 mb-4 border-b border-gray-800">
                                <button type="button" class="tab-button active px-4 py-2 border-b-2 border-transparent text-sm font-medium" data-method="card">
                                    <i data-lucide="credit-card" width="16" height="16" class="inline mr-2"></i>
                                    Card
                                </button>
                                <button type="button" class="tab-button px-4 py-2 border-b-2 border-transparent text-sm font-medium" data-method="bank_transfer">
                                    <i data-lucide="building-2" width="16" height="16" class="inline mr-2"></i>
                                    Bank Transfer
                                </button>
                                <button type="button" class="tab-button px-4 py-2 border-b-2 border-transparent text-sm font-medium" data-method="paypal">
                                    <i data-lucide="wallet" width="16" height="16" class="inline mr-2"></i>
                                    PayPal
                                </button>
                            </div>

                            <form id="paymentForm" class="space-y-4">
                                <input type="hidden" name="paymentMethod" id="paymentMethod" value="card">

                                <!-- Card Payment Form -->
                                <div id="cardForm" class="payment-method-form">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Card Number</label>
                                        <div class="relative">
                                            <input type="text" 
                                                   id="cardNumber" 
                                                   name="cardNumber"
                                                   maxlength="19"
                                                   placeholder="1234 5678 9012 3456"
                                                   class="card-input card-number-input w-full rounded-lg px-4 py-3 text-white focus:outline-none"
                                                   required>
                                            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex gap-2">
                                                <img src="https://img.icons8.com/color/24/000000/visa.png" class="card-logo" alt="Visa" style="display: none;" id="visa-logo">
                                                <img src="https://img.icons8.com/color/24/000000/mastercard.png" class="card-logo" alt="Mastercard" style="display: none;" id="mastercard-logo">
                                                <img src="https://img.icons8.com/color/24/000000/amex.png" class="card-logo" alt="Amex" style="display: none;" id="amex-logo">
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Test cards: 4242 4242 4242 4242 (Visa), 5555 5555 5555 4444 (Mastercard)</p>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Expiry Date</label>
                                            <input type="text" 
                                                   id="expiryDate" 
                                                   name="expiryDate"
                                                   maxlength="5"
                                                   placeholder="MM/YY"
                                                   class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none"
                                                   required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">CVV</label>
                                            <input type="text" 
                                                   id="cvv" 
                                                   name="cvv"
                                                   maxlength="4"
                                                   placeholder="123"
                                                   class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none"
                                                   required>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Cardholder Name</label>
                                        <input type="text" 
                                               id="cardName" 
                                               name="cardName"
                                               placeholder="John Doe"
                                               class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none"
                                               required>
                                    </div>
                                </div>

                                <!-- Bank Transfer Form -->
                                <div id="bankTransferForm" class="payment-method-form hidden">
                                    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-4">
                                        <p class="text-sm text-blue-300 mb-2"><i data-lucide="info" width="16" height="16" class="inline mr-1"></i> Bank Transfer Instructions</p>
                                        <div class="text-xs text-gray-400 space-y-1">
                                            <p><strong>Bank:</strong> Demo Bank International</p>
                                            <p><strong>Account Number:</strong> 1234567890</p>
                                            <p><strong>Routing Number:</strong> 987654321</p>
                                            <p><strong>SWIFT:</strong> DEMOUS33</p>
                                            <p><strong>Amount:</strong> <%= job.payment %></p>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Transaction Reference Number</label>
                                        <input type="text" 
                                               id="bankReference" 
                                               name="bankReference"
                                               placeholder="Enter your bank transfer reference"
                                               class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none">
                                    </div>
                                </div>

                                <!-- PayPal Form -->
                                <div id="paypalForm" class="payment-method-form hidden">
                                    <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mb-4">
                                        <p class="text-sm text-yellow-300 mb-2"><i data-lucide="info" width="16" height="16" class="inline mr-1"></i> PayPal Payment</p>
                                        <p class="text-xs text-gray-400">You will be redirected to PayPal to complete your payment. This is a demo payment system.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">PayPal Email</label>
                                        <input type="email" 
                                               id="paypalEmail" 
                                               name="paypalEmail"
                                               placeholder="your.email@example.com"
                                               class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Additional Notes (Optional)</label>
                                    <textarea name="notes" 
                                              rows="3" 
                                              placeholder="Any additional information about this payment"
                                              class="card-input w-full rounded-lg px-4 py-3 text-white focus:outline-none"></textarea>
                                </div>

                                <button type="submit" 
                                        id="submitBtn"
                                        class="w-full bg-gradient-to-r from-[#ff6b35] to-[#ff8c42] hover:from-[#ff8c42] hover:to-[#ff6b35] text-white font-semibold px-6 py-4 rounded-lg transition-all transform hover:scale-[1.02] shadow-lg">
                                    <span id="submitText">Pay <%= job.payment %></span>
                                    <span id="submitLoading" class="hidden">
                                        <i data-lucide="loader-2" width="20" height="20" class="inline animate-spin mr-2"></i>
                                        Processing...
                                    </span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Security Info -->
                <div class="md:col-span-1">
                    <div class="payment-card rounded-2xl p-6 mb-4">
                        <h3 class="text-lg font-semibold mb-4">Security & Trust</h3>
                        <div class="space-y-3">
                            <div class="security-badge rounded-lg p-3 flex items-center gap-3">
                                <i data-lucide="shield-check" width="20" height="20" class="text-green-400"></i>
                                <div>
                                    <p class="text-sm font-medium">SSL Encrypted</p>
                                    <p class="text-xs text-gray-400">256-bit encryption</p>
                                </div>
                            </div>
                            <div class="security-badge rounded-lg p-3 flex items-center gap-3">
                                <i data-lucide="lock" width="20" height="20" class="text-green-400"></i>
                                <div>
                                    <p class="text-sm font-medium">Secure Payment</p>
                                    <p class="text-xs text-gray-400">PCI DSS compliant</p>
                                </div>
                            </div>
                            <div class="security-badge rounded-lg p-3 flex items-center gap-3">
                                <i data-lucide="credit-card" width="20" height="20" class="text-green-400"></i>
                                <div>
                                    <p class="text-sm font-medium">No Card Storage</p>
                                    <p class="text-xs text-gray-400">Your card is never saved</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
                        <p class="text-sm font-medium text-yellow-300 mb-2">
                            <i data-lucide="alert-circle" width="16" height="16" class="inline mr-1"></i>
                            Demo Mode
                        </p>
                        <p class="text-xs text-gray-400">This is a test payment system. No real charges will be made. Use test card numbers for demonstration.</p>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="text-center">
            <div class="spinner w-16 h-16 rounded-full mx-auto mb-4"></div>
            <p class="text-xl font-semibold mb-2">Processing Payment...</p>
            <p class="text-gray-400 text-sm">Please wait while we securely process your payment</p>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const method = btn.dataset.method;
                
                // Update active tab
                document.querySelectorAll('.tab-button').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                
                // Update hidden input
                document.getElementById('paymentMethod').value = method;
                
                // Show/hide forms
                document.querySelectorAll('.payment-method-form').forEach(form => {
                    form.classList.add('hidden');
                });
                
                if (method === 'card') {
                    document.getElementById('cardForm').classList.remove('hidden');
                } else if (method === 'bank_transfer') {
                    document.getElementById('bankTransferForm').classList.remove('hidden');
                } else if (method === 'paypal') {
                    document.getElementById('paypalForm').classList.remove('hidden');
                }
            });
        });

        // Card number formatting and validation
        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\s/g, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formatted;
                
                // Detect card type
                const firstDigit = value[0];
                const firstTwo = value.substring(0, 2);
                
                document.getElementById('visa-logo').style.display = 'none';
                document.getElementById('mastercard-logo').style.display = 'none';
                document.getElementById('amex-logo').style.display = 'none';
                
                if (firstDigit === '4') {
                    document.getElementById('visa-logo').style.display = 'block';
                } else if (firstTwo >= '51' && firstTwo <= '55') {
                    document.getElementById('mastercard-logo').style.display = 'block';
                } else if (firstTwo === '34' || firstTwo === '37') {
                    document.getElementById('amex-logo').style.display = 'block';
                }
            });
        }

        // Expiry date formatting
        const expiryInput = document.getElementById('expiryDate');
        if (expiryInput) {
            expiryInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        // CVV validation
        const cvvInput = document.getElementById('cvv');
        if (cvvInput) {
            cvvInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }

        // Form submission
        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm) {
            paymentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submitBtn');
                const submitText = document.getElementById('submitText');
                const submitLoading = document.getElementById('submitLoading');
                const processingOverlay = document.getElementById('processingOverlay');
                
                // Validate card form if card is selected
                const paymentMethod = document.getElementById('paymentMethod').value;
                if (paymentMethod === 'card') {
                    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                    const expiry = document.getElementById('expiryDate').value;
                    const cvv = document.getElementById('cvv').value;
                    const cardName = document.getElementById('cardName').value;
                    
                    if (!cardNumber || cardNumber.length < 13) {
                        alert('Please enter a valid card number');
                        return;
                    }
                    
                    if (!expiry || expiry.length !== 5) {
                        alert('Please enter a valid expiry date (MM/YY)');
                        return;
                    }
                    
                    if (!cvv || cvv.length < 3) {
                        alert('Please enter a valid CVV');
                        return;
                    }
                    
                    if (!cardName) {
                        alert('Please enter cardholder name');
                        return;
                    }
                }
                
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                submitLoading.classList.remove('hidden');
                processingOverlay.classList.remove('hidden');
                
                // Prepare data
                const formData = new FormData(paymentForm);
                const data = {
                    paymentMethod: formData.get('paymentMethod'),
                    notes: formData.get('notes') || null
                };
                
                // Add method-specific data
                if (paymentMethod === 'card') {
                    data.cardNumber = formData.get('cardNumber');
                    data.expiryDate = formData.get('expiryDate');
                    data.cvv = formData.get('cvv');
                    data.cardName = formData.get('cardName');
                } else if (paymentMethod === 'bank_transfer') {
                    data.bankReference = formData.get('bankReference');
                } else if (paymentMethod === 'paypal') {
                    data.paypalEmail = formData.get('paypalEmail');
                }
                
                // Simulate processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                try {
                    const response = await fetch('/job/<%= job._id %>/payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Show success animation
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        processingOverlay.classList.add('hidden');
                        
                        // Redirect to show success page
                        window.location.reload();
                    } else {
                        processingOverlay.classList.add('hidden');
                        submitBtn.disabled = false;
                        submitText.classList.remove('hidden');
                        submitLoading.classList.add('hidden');
                        alert('Error: ' + (result.error || 'Failed to process payment'));
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    processingOverlay.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitText.classList.remove('hidden');
                    submitLoading.classList.add('hidden');
                    alert('An error occurred while processing payment. Please try again.');
                }
            });
        }
    </script>
</body>
</html>
