<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: 'Montserrat', sans-serif;
    color: #fff;
    overflow: hidden;
}

.chat-main {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    background-color: #0b0b0b;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background-color: #111;
    border-bottom: 1px solid #353535;
    flex-shrink: 0;
}

.search-bar .search-icon {
    font-size: 0.65rem;
    transform: translateY(1px);
}

.sidebar-search .search-icon {
    width: 0.7rem !important;
    height: 0.7rem !important;
    transform: translateY(-1px);
    margin-right: 1rem;
}

.search-bar {
    display: flex;
    align-items: center;
    background-color: #0f0f0f;
    border: 0.6px solid #828282;
    border-radius: 15.9px;
    padding: 0.5rem 1rem;
}

.create-chat-icon {
    font-size: 1.2rem;
    color: #929bff;
    cursor: pointer;
    transition: color 0.3s ease;
}

.create-chat-icon:hover {
    color: white;
}

.search-icon {
    width: 0.75rem;
    height: 0.75rem;
    margin-right: 0.5rem;
}

.search-input {
    background: none;
    border: none;
    color: #828282;
    font-size: 0.829rem;
    outline: none;
}

.nav-links {
    display: flex;
    gap: 2rem;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transform: translateX(400px);
}

.nav-item.active .nav-icon,
.nav-item.active .nav-text {
    color: #929bff;
}

.nav-icon,
.nav-text {
    color: white;
    transition: color 0.3s ease;
}

.nav-item:not(.active):hover .nav-icon,
.nav-item:not(.active):hover .nav-text {
    color: #929bff;
}

.nav-icon {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 0.40rem;
}

.nav-text {
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    line-height: 1;
}

.nav-text.active {
    color: #929bff;
}

.profile-image {
    width: 2.313rem;
    height: 2.313rem;
    border-radius: 50%;
    object-fit: cover;
}

.main-content {
    display: flex;
    flex-grow: 1;
    height: calc(100vh - 70px);
}

.sidebar {
    width: 24rem;
    background-color: #0e0f0f;
    border-right: 1px solid #353535;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    padding-left: 1rem;
    padding-right: 1rem;
    margin-top: 1rem;
}

.chat-list {
    flex-grow: 1;
    overflow-y: auto;
}

.chat-list::-webkit-scrollbar {
    width: 0px
}

.chat-list::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}

.chat-list::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0;
}

.sidebar-search {
    display: flex;
    align-items: center;
    background-color: #0b0b0b;
    border: 0.4px solid #828282;
    border-radius: 34px;
    padding: 0.5rem 1rem;
    flex-grow: 1;
    margin-right: 1rem;
}

.sidebar-search-input {
    background: none;
    border: none;
    color: #828282;
    outline: none;
}

.edit-icon {
    width: 1.375rem;
    height: 1.375rem;
    object-fit: cover;
}

.chat-list {
    margin-top: 1rem;
    overflow-y: auto;
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 18px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    background-color: #0b0b0b;
    transition: background-color 0.2s ease;
}

.chat-item:hover {
    background-color: #151515;
}

.active-chat {
    background-color: #151515;
    border: 1px solid #565656;
}

.chat-image {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 1rem;
}

.chat-info {
    flex-grow: 1;
}

.chat-name {
    font-size: 1.25rem;
    font-weight: 500;
}

.chat-designation {
    font-size: 0.75rem;
    color: #929bff;
}

.chat-date {
    font-size: 0.625rem;
    color: #929bff;
}

.chat-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background-color: #0e0f0f;
    padding: 1rem;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #353535;
    flex-shrink: 0;
}

.chat-user-name {
    font-size: 1.25rem;
    font-weight: 500;
}

.chat-actions {
    display: flex;
    gap: 1rem;
}

.chat-action-icon {
    width: 1.75rem;
    height: 1.75rem;
    cursor: pointer;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.send-button {
    background-color: #0e0f0f;
    border: none;
    padding: 0.4rem 0.6rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.5rem;
    transition: background-color 0.3s ease;
}

.send-button i {
    color: white;
    font-size: 0.9rem;
}

.send-button:hover {
    background-color: #7c88ff;
}

.message {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
}

.message-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
}

.message-bubble {
    padding: 1rem;
    border-radius: 12px;
}

.received-message .message-bubble {
    background-color: #151515;
    border: 0.4px solid #949494;
}

.sent-message {
    justify-content: flex-end;
}

.sent-message .message-bubble {
    background-color: #007bff;
    color: white;
}

.chat-input-area {
    display: flex;
    align-items: center;
    background-color: #151515;
    border: 0.4px solid #949494;
    border-radius: 24px;
    padding: 0.5rem 1rem;
    flex-shrink: 0;
    margin-top: auto;
}

.input-icon {
    width: 1.4rem;
    height: 1.4rem;
    cursor: pointer;
    margin-right: 0.5rem;
    margin-top: 0.5rem;
}

.chat-input {
    background: none;
    border: none;
    flex-grow: 1;
    color: #949494;
    outline: none;
}

.profile-sidebar {
    width: 20rem;
    background-color: #0e0f0f;
    border-left: 1px solid #353535;
    flex-shrink: 0;
}

@media (max-width: 1900px) {
    .sidebar {
        width: 19rem;
    }
    .profile-sidebar {
        width: 15rem;
    }
    .nav-links {
        gap: 1.5rem;
        margin-right: 20rem;
    }
    .chat-container {
        padding: 0.8rem;
    }
}

  </style>
</head>
<body>
  <div class="chat-main">
    <!-- Header -->
    <header class="header">
      <div class="search-bar">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Parin goat?">
      </div>
      <nav class="nav-links">
        <div class="nav-item active">
          <i class="fas fa-home nav-icon"></i>
          <div class="nav-text">Home</div>
        </div>
        <div class="nav-item">
          <i class="fas fa-user-friends nav-icon"></i>
          <div class="nav-text">Network</div>
        </div>
        <div class="nav-item">
          <i class="fas fa-comment-dots nav-icon"></i>
          <div class="nav-text">Messaging</div>
        </div>
        <div class="nav-item">
          <i class="fas fa-bell nav-icon"></i>
          <div class="nav-text">Notifications</div>
        </div>
      </nav>
      <img class="profile-image" alt="" src="/images/avatar.png">
    </header>

    <main class="main-content">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-search">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="sidebar-search-input" placeholder="Search...">
          </div>
          <i class="fas fa-plus create-chat-icon" title="Create New Chat"></i>
        </div>

        <div class="chat-list">
          <% friends.forEach(friend => { %>
            <div 
              class="chat-item friend-item"
              data-friend-id="<%= friend._id %>"
              data-friend-username="<%= friend.username %>"
            >
              <img class="chat-image" alt="" src="/images/avatar.png">
              <div class="chat-info">
                <div class="chat-name"><%= friend.username %></div>
                <div class="chat-designation">Friend</div>
              </div>
              <div class="chat-date"></div>
            </div>
          <% }) %>
        </div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container">
        <div class="chat-header">
          <div id="chatHeader" class="chat-user-name">Select a friend to chat</div>
          <div class="chat-actions">
            <i class="fas fa-video chat-action-icon"></i>
            <i class="fas fa-ellipsis-h chat-action-icon"></i>
          </div>
        </div>

        <!-- Messages -->
        <div id="chatBox" class="chat-messages"></div>

        <!-- Input -->
        <form id="chatForm" class="chat-input-area hidden">
          <i class="far fa-smile input-icon"></i>
          <i class="fas fa-paperclip input-icon"></i>
          <input type="text" id="msgInput" class="chat-input" placeholder="Type message">
          <i class="fas fa-microphone input-icon"></i>
          <button class="send-button" title="Send">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>

      <!-- Profile Sidebar -->
      <div class="profile-sidebar">
        <div class="profile-info" style="padding: 1rem; text-align: center;">
          <img src="/images/avatar.png" alt="Profile Picture" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem;">
          <h3 style="margin: 0; color: white;">User Name</h3>
          <p style="color: #929bff; font-size: 0.9rem; margin: 0;">UI/UX Designer</p>
        </div>

        <div class="profile-actions" style="margin-top: 1rem; padding: 0 1rem;">
          <button style="width: 100%; padding: 0.5rem; background-color: #929bff; border: none; border-radius: 6px; color: black; cursor: pointer; font-weight: 200;">
            Edit Profile
          </button>
          <button style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; background-color: #151515; border: 1px solid #353535; border-radius: 6px; color: white; cursor: pointer;">
            Settings
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const socket = io();
    let currentFriendId = null;
    let myId = "<%= me %>";

    const chatBox = document.getElementById("chatBox");
    const chatHeader = document.getElementById("chatHeader");
    const chatForm = document.getElementById("chatForm");
    const msgInput = document.getElementById("msgInput");

    async function loadChat(friendId, friendName) {
      currentFriendId = friendId;
      chatHeader.textContent = `Chat with ${friendName}`;
      chatForm.classList.remove("hidden");

      const res = await fetch(`/messages/${friendId}`);
      const data = await res.json();

      myId = data.me;
      chatBox.innerHTML = "";
      data.messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = (msg.from._id === myId) ? "message sent-message" : "message received-message";

        if (msg.from._id !== myId) {
          const avatar = document.createElement("img");
          avatar.className = "message-avatar";
          avatar.src = "/images/avatar.png";
          div.appendChild(avatar);
        }

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        const text = document.createElement("div");
        text.className = "message-text";
        text.textContent = msg.content;
        bubble.appendChild(text);

        div.appendChild(bubble);

        if (msg.from._id === myId) {
          const avatar = document.createElement("img");
          avatar.className = "message-avatar";
          avatar.src = "/images/avatar.png";
          div.appendChild(avatar);
        }

        chatBox.appendChild(div);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
      socket.emit("joinRoom", { userId: myId, friendId: currentFriendId });
    }

    document.querySelectorAll(".friend-item").forEach(item => {
      item.addEventListener("click", () => {
        loadChat(item.dataset.friendId, item.dataset.friendUsername);
      });
    });

    chatForm.addEventListener("submit", e => {
      e.preventDefault();
      const content = msgInput.value.trim();
      if (!content || !currentFriendId) return;

      socket.emit("sendMessage", { from: myId, to: currentFriendId, content });
      msgInput.value = "";
    });

    socket.on("newMessage", msg => {
      if (msg.from !== myId && msg.from !== currentFriendId) return;

      const isMine = msg.from === myId;
      const div = document.createElement("div");
      div.className = isMine ? "message sent-message" : "message received-message";

      if (!isMine) {
        const avatar = document.createElement("img");
        avatar.className = "message-avatar";
        avatar.src = "/images/avatar.png";
        div.appendChild(avatar);
      }

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      const text = document.createElement("div");
      text.className = "message-text";
      text.textContent = msg.content;
      bubble.appendChild(text);

      div.appendChild(bubble);

      if (isMine) {
        const avatar = document.createElement("img");
        avatar.className = "message-avatar";
        avatar.src = "/images/avatar.png";
        div.appendChild(avatar);
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    const params = new URLSearchParams(window.location.search);
    if (params.has("open")) {
      const friendId = params.get("open");
      const item = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
      if (item) {
        loadChat(item.dataset.friendId, item.dataset.friendUsername);
      }
    }
  </script>
</body>
</html>
