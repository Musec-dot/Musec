<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lo-Fi Studio Live</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #050505;
        color: #ffffff;
      }
      /* Custom Scrollbar for Chat */
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      /* Animation Utilities */
      .animate-bounce {
        animation: bounce 1s infinite;
      }
      @keyframes bounce {
        0%, 100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
          transform: translateY(0);
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
  <body class="overflow-hidden">
    
    <!-- App Container -->
    <div id="root" class="flex h-screen w-full bg-[#050505] overflow-hidden text-white font-sans selection:bg-orange-500/30">
      
      <!-- LEFT SIDEBAR: Live Chat -->
      <div class="w-80 flex flex-col h-full border-r border-white/5 bg-[#09090b]">
        <!-- Header -->
        <div class="p-6 flex justify-between items-center border-b border-white/5">
          <h2 class="text-gray-200 font-semibold text-lg">Live Chat</h2>
          <div class="flex items-center gap-2 text-orange-500 bg-orange-500/10 px-3 py-1 rounded-full text-xs font-medium">
            <i data-lucide="users" class="w-[14px] h-[14px]"></i>
            <span id="viewer-count">0</span>
          </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide">
          <!-- Messages will be injected here by JS -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-white/5">
          <div class="relative">
            <input 
              type="text" 
              id="chat-input"
              placeholder="Send a message..." 
              class="w-full bg-[#18181b] text-sm text-gray-200 rounded-full pl-4 pr-10 py-3 focus:outline-none focus:ring-1 focus:ring-orange-500/50 transition-all placeholder-gray-600"
            />
            <button id="send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-orange-500 hover:text-orange-400 transition-colors">
              <i data-lucide="send" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- MAIN STAGE -->
      <div class="flex-1 relative flex flex-col h-full">
        <!-- Glow Effect -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[400px] bg-orange-600/10 blur-[120px] rounded-full pointer-events-none"></div>
        
        <div class="flex-1 p-8 flex flex-col items-center justify-center relative">
          <!-- Video Container -->
          <div class="relative w-full max-w-5xl aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl ring-1 ring-white/10 group">
            
            <!-- Video Element -->
            <video id="vid" autoplay muted playsinline class="w-full h-full object-cover"></video>

            <!-- Background Image (fallback when no video) -->
            <div id="fallback-bg" class="absolute inset-0">
              <img 
                src="https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?q=80&w=2670&auto=format&fit=crop" 
                alt="Studio Session" 
                class="w-full h-full object-cover opacity-80"
              />
              <!-- Gradient Overlay -->
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/60"></div>
            </div>

            <!-- Top Bar Overlay -->
            <div class="absolute top-0 left-0 right-0 p-6 flex justify-between items-start">
              <div class="flex items-center gap-4">
                <div class="bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg shadow-red-900/20 animate-pulse">
                  <div class="w-2 h-2 bg-white rounded-full"></div>
                  LIVE
                </div>
                <div class="bg-black/40 backdrop-blur-md text-gray-200 text-sm font-medium px-4 py-1.5 rounded-full border border-white/5">
                  Lo-Fi Studio Session
                </div>
              </div>

              <div class="flex items-center gap-3">
                <div class="bg-black/40 backdrop-blur-md text-gray-200 px-4 py-1.5 rounded-full border border-white/5 flex items-center gap-2 text-sm">
                  <i data-lucide="eye" class="text-orange-500 w-4 h-4"></i>
                  <span id="viewer-count-top">0</span>
                </div>
                <div id="stream-timer" class="bg-black/40 backdrop-blur-md text-gray-200 px-4 py-1.5 rounded-full border border-white/5 text-sm font-mono">
                  00:00:00
                </div>
                <div class="bg-black/40 backdrop-blur-md p-1.5 rounded-full border border-white/5 text-green-500">
                   <i data-lucide="activity" class="w-[18px] h-[18px]"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CONTROL BAR -->
        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-50">
          <div class="flex items-center gap-2 bg-[#18181b]/90 backdrop-blur-xl border border-white/10 rounded-full p-2 pl-4 pr-2 shadow-2xl">
            <!-- Media Controls -->
            <div class="flex items-center gap-1">
              <button id="video-toggle" class="w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                <i data-lucide="video" class="w-5 h-5"></i>
              </button>
              <button id="mute" class="w-10 h-10 flex items-center justify-center rounded-full text-orange-500 bg-orange-500/10 hover:bg-orange-500/20 transition-all">
                <i data-lucide="mic" class="w-5 h-5"></i>
              </button>
            </div>

            <div class="w-px h-8 bg-white/10 mx-2"></div>

            <!-- Screen Share -->
            <button id="share" class="w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                 <i data-lucide="monitor" class="w-5 h-5"></i>
            </button>

            <!-- CTA -->
            <form action="/end-stream" method="POST" class="inline">
              <button type="submit" class="mx-2 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white text-sm font-semibold px-6 py-2.5 rounded-full shadow-lg shadow-orange-900/40 transition-all transform hover:scale-105">
                End Stream
              </button>
            </form>

            <!-- Settings -->
            <div class="w-px h-8 bg-white/10 mx-2"></div>

            <button class="w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition-all">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR: Session Details -->
      <div class="w-80 flex flex-col h-full border-l border-white/5 bg-[#09090b] p-6 space-y-8">
        <!-- Header -->
        <h2 class="text-gray-200 font-semibold text-lg">Session Details</h2>

        <!-- Now Playing Card -->
        <div>
          <h3 class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-4">Now Playing</h3>
          <div class="bg-[#18181b] rounded-2xl p-4 border border-white/5 shadow-lg">
            <div class="flex items-center gap-4 mb-4">
              <div class="relative w-12 h-12 rounded-lg overflow-hidden group">
                <img src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?w=300&auto=format&fit=crop&q=60" alt="Album Art" class="w-full h-full object-cover" />
                <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                   <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                   <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce mx-0.5" style="animation-delay: 0.1s"></div>
                   <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
              <div class="overflow-hidden">
                <h4 class="text-white text-sm font-semibold truncate">Midnight Vibes</h4>
                <p class="text-gray-400 text-xs truncate">Lo-Fi Hip Hop</p>
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-gray-800 h-1 rounded-full mb-2">
              <div class="bg-orange-500 h-1 rounded-full relative" style="width: 65%">
                 <div class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full shadow-md"></div>
              </div>
            </div>
            <div class="flex justify-end mb-4">
              <span class="text-[10px] text-gray-500">2:15</span>
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-center gap-4">
               <button class="text-gray-400 hover:text-white transition-colors">
                 <i data-lucide="skip-back" class="w-[18px] h-[18px]" fill="currentColor"></i>
               </button>
               
               <button 
                  id="play-button"
                  class="w-10 h-10 bg-orange-500 hover:bg-orange-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-orange-900/50 transition-all"
               >
                  <!-- Play Icon (Default) -->
                  <i id="icon-play" data-lucide="play" class="w-[18px] h-[18px] ml-0.5" fill="currentColor"></i>
                  <!-- Pause Icon (Hidden) -->
                  <i id="icon-pause" data-lucide="pause" class="w-[18px] h-[18px] hidden" fill="currentColor"></i>
               </button>
               
               <button class="text-gray-400 hover:text-white transition-colors">
                 <i data-lucide="skip-forward" class="w-[18px] h-[18px]" fill="currentColor"></i>
               </button>
            </div>
          </div>
        </div>

        <!-- Session Info -->
        <div class="space-y-6">
          <h3 class="text-gray-400 text-xs font-medium uppercase tracking-wider">Session Info</h3>
          
          <div class="space-y-4">
              <div class="flex items-start gap-3">
                  <i data-lucide="hash" class="text-orange-500 w-4 h-4 mt-0.5"></i>
                  <div class="flex flex-wrap gap-2">
                      <span class="text-sm text-gray-300">#LoFi</span>
                      <span class="text-sm text-gray-300">#StudioJam</span>
                      <span class="text-sm text-gray-300">#Chill</span>
                  </div>
              </div>

              <div class="flex items-center gap-3">
                  <i data-lucide="clock" class="text-orange-500 w-4 h-4"></i>
                  <span id="session-time" class="text-sm text-gray-300">Started just now</span>
              </div>
          </div>

          <!-- Toggle -->
          <div class="pt-6 border-t border-white/5 flex items-center justify-between">
              <span class="text-sm text-gray-300">Allow Collab Requests</span>
              <button 
                  id="collab-toggle"
                  class="w-11 h-6 rounded-full p-1 transition-colors duration-200 ease-in-out bg-orange-500"
              >
                  <div id="collab-knob" class="w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform duration-200 translate-x-5"></div>
              </button>
          </div>
        </div>

      </div>
    </div>

    <!-- Application Logic -->
    <script>
      // EJS Template Data
      const streamId = "<%= stream.streamId %>";
      const socket = io();
      const video = document.getElementById('vid');
      const peers = {};
      let stream, screen = false;
      let viewerCount = 0;
      let streamStartTime = Date.now();

      // Initialize media stream
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(s => {
          stream = s;
          video.srcObject = s;
          document.getElementById('fallback-bg').style.display = 'none';
          socket.emit('broadcaster', { streamId });
        })
        .catch(err => {
          console.error('Error accessing media devices:', err);
        });

      // ICE helper
      const newPC = id => {
        const pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        pc.onicecandidate = e => e.candidate && socket.emit('candidate', id, e.candidate);
        return pc;
      };

      // WebRTC signaling
      socket.on('watcher', id => {
        viewerCount++;
        updateViewerCount();
        const pc = peers[id] = newPC(id);
        pc.createOffer()
          .then(d => pc.setLocalDescription(d))
          .then(() => socket.emit('offer', id, pc.localDescription));
      });

      socket.on('answer', (id, desc) => peers[id]?.setRemoteDescription(desc));
      socket.on('candidate', (id, cand) => peers[id]?.addIceCandidate(new RTCIceCandidate(cand)));
      socket.on('disconnectPeer', id => {
        peers[id]?.close();
        delete peers[id];
        viewerCount = Math.max(0, viewerCount - 1);
        updateViewerCount();
      });

      // Update viewer count
      function updateViewerCount() {
        document.getElementById('viewer-count').textContent = viewerCount;
        document.getElementById('viewer-count-top').textContent = viewerCount;
      }

      // Stream timer
      function updateStreamTimer() {
        const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('stream-timer').textContent = timeString;
      }
      setInterval(updateStreamTimer, 1000);

      // Mute toggle
      const muteBtn = document.getElementById('mute');
      let isMuted = false;
      muteBtn.addEventListener('click', e => {
        if (stream) {
          stream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
          isMuted = !isMuted;
          muteBtn.classList.toggle('text-orange-500', !isMuted);
          muteBtn.classList.toggle('bg-orange-500/10', !isMuted);
          muteBtn.classList.toggle('text-gray-400', isMuted);
          muteBtn.classList.toggle('bg-transparent', isMuted);
        }
      });

      // Video toggle
      const videoToggleBtn = document.getElementById('video-toggle');
      let videoEnabled = true;
      videoToggleBtn.addEventListener('click', e => {
        if (stream) {
          stream.getVideoTracks().forEach(t => t.enabled = !t.enabled);
          videoEnabled = !videoEnabled;
          videoToggleBtn.classList.toggle('text-orange-500', videoEnabled);
          videoToggleBtn.classList.toggle('bg-orange-500/10', videoEnabled);
          videoToggleBtn.classList.toggle('text-gray-400', !videoEnabled);
          videoToggleBtn.classList.toggle('bg-transparent', !videoEnabled);
        }
      });

      // Screen share
      const shareBtn = document.getElementById('share');
      shareBtn.addEventListener('click', async e => {
        if (!screen) {
          try {
            const sS = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const track = sS.getVideoTracks()[0];
            for (const pc of Object.values(peers)) {
              const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
              if (sender) sender.replaceTrack(track);
            }
            track.onended = () => shareBtn.click();
            shareBtn.classList.add('text-orange-500', 'bg-orange-500/10');
            shareBtn.classList.remove('text-gray-400');
            screen = true;
          } catch (err) {
            console.error('Error sharing screen:', err);
          }
        } else {
          if (stream) {
            const cam = stream.getVideoTracks()[0];
            for (const pc of Object.values(peers)) {
              const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
              if (sender) sender.replaceTrack(cam);
            }
            shareBtn.classList.remove('text-orange-500', 'bg-orange-500/10');
            shareBtn.classList.add('text-gray-400');
            screen = false;
          }
        }
      });

      // Chat functionality
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const chatContainer = document.getElementById('chat-container');

      function addMessage(user, message, role = 'user') {
        let roleColorClass = 'text-gray-300';
        let roleBadge = '';
        
        if (role === 'mod') {
          roleColorClass = 'text-orange-400';
          roleBadge = '<span class="text-[10px] bg-orange-500/20 text-orange-400 px-1.5 py-0.5 rounded ml-2">MOD</span>';
        } else if (role === 'vip') {
          roleColorClass = 'text-purple-400';
        }

        const msgHtml = `
          <div class="flex gap-3 items-start group">
            <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center ring-2 ring-transparent group-hover:ring-orange-500/50 transition-all">
              <span class="text-xs font-semibold text-orange-400">${user.charAt(0).toUpperCase()}</span>
            </div>
            <div>
              <div class="flex items-center mb-1">
                <span class="text-sm font-semibold ${roleColorClass}">
                  ${user}
                </span>
                ${roleBadge}
              </div>
              <p class="text-sm text-gray-400 leading-relaxed font-light">${message}</p>
            </div>
          </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', msgHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
          addMessage('You', message, 'mod');
          // Emit to socket if you want to broadcast to viewers
          socket.emit('chat-message', { streamId, user: 'You', message });
          chatInput.value = '';
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });

      // Play/Pause Interaction
      const playBtn = document.getElementById('play-button');
      const iconPlay = document.getElementById('icon-play');
      const iconPause = document.getElementById('icon-pause');
      let isPlaying = false;

      playBtn.addEventListener('click', () => {
        isPlaying = !isPlaying;
        if (isPlaying) {
          iconPlay.classList.add('hidden');
          iconPause.classList.remove('hidden');
        } else {
          iconPlay.classList.remove('hidden');
          iconPause.classList.add('hidden');
        }
      });

      // Toggle Interaction
      const toggleBtn = document.getElementById('collab-toggle');
      const toggleKnob = document.getElementById('collab-knob');
      let collabEnabled = true;

      toggleBtn.addEventListener('click', () => {
        collabEnabled = !collabEnabled;
        if (collabEnabled) {
          toggleBtn.classList.remove('bg-gray-700');
          toggleBtn.classList.add('bg-orange-500');
          toggleKnob.classList.remove('translate-x-0');
          toggleKnob.classList.add('translate-x-5');
        } else {
          toggleBtn.classList.remove('bg-orange-500');
          toggleBtn.classList.add('bg-gray-700');
          toggleKnob.classList.remove('translate-x-5');
          toggleKnob.classList.add('translate-x-0');
        }
      });

      // Initialize Icons
      lucide.createIcons();
    </script>
  </body>
</html>
