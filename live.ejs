<!DOCTYPE html>
<html lang="en" class="bg-[#0f0f1b] text-white">
<head>
  <meta charset="UTF-8" />
  <title>Go Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen gap-6">

  <h1 class="text-2xl font-bold text-purple-400">ğŸ¥ You're Live</h1>
  <video id="video" autoplay muted playsinline class="rounded-lg shadow-xl w-[720px] h-[405px] bg-black"></video>

  <div class="flex gap-4">
    <button id="muteBtn" class="px-4 py-2 bg-purple-600 rounded hover:bg-purple-700">Mute</button>
    <button id="screenShareBtn" class="px-4 py-2 bg-purple-600 rounded hover:bg-purple-700">Share Screen</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const socket = io();
    const peers = {};
    let stream;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
      stream = s;
      video.srcObject = stream;
      socket.emit('broadcaster');
    });

    socket.on('watcher', id => {
      const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      peers[id] = pc;

      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      pc.onicecandidate = e => {
        if (e.candidate) socket.emit('candidate', id, e.candidate);
      };

      pc.createOffer().then(d => pc.setLocalDescription(d)).then(() => {
        socket.emit('offer', id, pc.localDescription);
      });
    });

    socket.on('answer', (id, desc) => {
      peers[id].setRemoteDescription(desc);
    });

    socket.on('candidate', (id, candidate) => {
      peers[id].addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on('disconnectPeer', id => {
      if (peers[id]) {
        peers[id].close();
        delete peers[id];
      }
    });

    // Mute / Unmute toggle
    document.getElementById('muteBtn').onclick = () => {
      stream.getAudioTracks().forEach(track => {
        track.enabled = !track.enabled;
      });
    };

    // Screen sharing
    document.getElementById('screenShareBtn').onclick = async () => {
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const screenTrack = screenStream.getVideoTracks()[0];

      for (let id in peers) {
        const sender = peers[id].getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(screenTrack);
      }

      screenTrack.onended = () => {
        stream.getVideoTracks().forEach(track => {
          for (let id in peers) {
            const sender = peers[id].getSenders().find(s => s.track.kind === 'video');
            if (sender) sender.replaceTrack(track);
          }
        });
      };
    };
  </script>
</body>
</html>
